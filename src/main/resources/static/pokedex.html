<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>仓库</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>

        .modal-content{
            width:700px;
            display: flex;
        }
        .modal-body{
            display: flex;
        }
        #pokemoninfotab{
            width: 400px;
            height: auto;

        }

        th{

            padding: 8px;
            text-align: left;
            white-space: nowrap; /* Prevent line breaks within the cell */
        }
        #introduction{
            font-size: 12px;
        }
        #container3d {
            width: 200px; /* 设置宽度 */
            height: 200px; /* 设置高度 */
            border: 2px solid #ccc; /* 设置边框 */
            margin: 10px; /* 设置外边距 */
            background-color: white; /* 设置背景颜色 */
            transition: width 0.5s, height 0.5s; /* 添加过渡效果 */
        }
    </style>
</head>
<body>
    <!-- 侧边导航栏 -->
    <nav class="sidebar">
        <div class="list-group">
            <div class="list-group-item list-group-item-heading">POKEMONHOME</div> <!-- 无法选中的头部 -->
        <a href="package.html" class="list-group-item list-group-item-action ">背包</a>
        <a href="storage.html" class="list-group-item list-group-item-action ">仓库</a>
        <a href="card.html" class="list-group-item list-group-item-action">训练师卡片</a>
        <a href="pokedex.html" class="list-group-item list-group-item-action  active">全图鉴</a>
        <a href="itemdex.html" class="list-group-item list-group-item-action">道具图鉴</a>
        <a href="exchange.html" class="list-group-item list-group-item-action">交换池</a>
        <a href="friends.html" class="list-group-item list-group-item-action ">好友</a>
        <a href="itemPackage.html" class="list-group-item list-group-item-action ">道具背包</a>
        <a href="trade.html" class="list-group-item list-group-item-action ">道聚城</a>
        <div class="divider"></div>

        </div>
    </nav>
    <!-- 主要内容 -->
    <div class="main-content">
        <!-- 上方导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="collapse navbar-collapse justify-content-end">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img id="trainer-avatar" src="" alt="头像" class="rounded-circle" width="30" height="30">
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="reset.html">更改密码</a>
                            <a class="dropdown-item" href="index.html">登出</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- 搜索和表格 -->
        <div class="container mt-3">
            <!-- 搜索 -->
            <div class="row">
                <div class="input-group rounded">
                    <input type="text" class="form-control" id="searchInput" placeholder="搜索...">
                    <div class="input-group-append">
                        <button class="btn btn-primary" id="searchButton" type="button">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                </div>
                <!-- 搜索模式选择 -->
                <div class="input-group mt-2">
                    <select class="form-control" id="searchMode">
                        <option value="name">按名字</option>
                        <option value="type">按属性</option>
                        <option value="pid">按编号</option>
                    </select>
                </div>
            </div>

            <!-- 显示表格 -->
            <div class="table-container row mt-3">
                <div class="col-md-12">
                    <table class="table table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>编号</th>
                                <th>名字</th>
                                <th>发现地点</th>
                                <th>属性</th>
                                <th>图像</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="pokemonTableBody">
                            <!-- 动态数据行 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div class="modal" id="pokemonModal" tabindex="-1" aria-labelledby="pokemonModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pokemonModalLabel"><strong>宝可梦信息</strong></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table id="pokemoninfotab" class="table table-bordered">
                        <tbody>
                            <tr>
                                <th>编号</th>
                                <td id="modalPid"></td>
                            </tr>
                            <tr>
                                <th>名字</th>
                                <td id="modalPname"></td>
                            </tr>
                            <tr>
                                <th>发现地点</th>
                                <td id="modalLocation"></td>
                            </tr>
                            <tr>
                                <th>属性</th>
                                <td id="modalType"></td>
                            </tr>
                            <tr>
                                <th>简介</th>
                                <td id="introduction"></td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="container3d"></div> <!-- 目标容器 -->
                </div>
            </div>
        </div>
    </div>
    <!-- 引入Bootstrap和jQuery的JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <!-- 引入 Three.js、OBJLoader.js 和 OrbitControls.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        const typeColors = {
            '火': '#ff4422',
            '水': '#3399ff',
            '草': '#77cc55',
            '电': '#ffcc33',
            '冰': '#77ddff',
            '格斗': '#bb5544',
            '毒': '#aa5599',
            '地面': '#ddbb55',
            '飞行': '#6699ff',
            '超能': '#ff5599',
            '虫': '#aabb22',
            '岩石': '#bbaa66',
            '幽灵': '#6666bb',
            '龙': '#7766ee',
            '恶': '#775544',
            '钢': '#aaaabb',
            '妖精': '#ffaaff',
            '一般': 'gray',
            '-': '#b2b2b2'
        };

        document.addEventListener('DOMContentLoaded', function () {
            fetchPokemons();
            fetch(`/get-trainer`)
                .then(response => response.json())
                .then(data => {
                    if (data.trainers && data.trainers.length > 0) {
                        const trainerInfo = data.trainers[0];
                        document.getElementById('trainer-avatar').src = trainerInfo.TrainerPic;
                    } else {
                        console.error('No trainer found');
                    }
                });

            document.getElementById('searchButton').addEventListener('click', function () {
                var query = document.getElementById('searchInput').value;
                var searchMode = document.getElementById('searchMode').value;
                searchPokemon(query, searchMode);
            });

            function fetchPokemons() {
                fetch('/allPokemon')
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.getElementById('pokemonTableBody');
                        tbody.innerHTML = ''; // 清空表格
                        data.pokemons.forEach(pokemon => {
                            const row = document.createElement('tr');
                            const type1Color = typeColors[pokemon.type1] || 'white';
                            const type2Color = typeColors[pokemon.type2] || 'white';
                            row.innerHTML = `
                                <td>${pokemon.pid}</td>
                                <td>${pokemon.pname}</td>
                                <td>${pokemon.location}</td>
                                <td>
                                    <span style="background-color: ${type1Color}; padding: 5px; border-radius: 5px; color: white; width: 50px; display: inline-block; text-align: center;">${pokemon.type1}</span>
                                    ${pokemon.type2 ? `<span style="background-color: ${type2Color}; padding: 5px; border-radius: 5px; color: white; width: 50px; display: inline-block; text-align: center; margin-left: 5px;">${pokemon.type2}</span>` : ''}
                                </td>
                                <td><img src="${pokemon.imageUrl}" alt="${pokemon.pname}" width="50" height="50"></td>
                                <td><button class="btn btn-info show-details" data-pokemon='${JSON.stringify(pokemon)}'>详情</button></td>
                            `;
                            tbody.appendChild(row);
                        });

                        document.querySelectorAll('.show-details').forEach(button => {
                            button.addEventListener('click', function() {
                                const pokemon = JSON.parse(this.getAttribute('data-pokemon'));
                                const type1Color = typeColors[pokemon.type1] || 'white';
                                const type2Color = typeColors[pokemon.type2] || 'white';
                                document.getElementById('modalPid').innerText = pokemon.pid;
                                document.getElementById('modalPname').innerText = pokemon.pname;
                                document.getElementById('modalLocation').innerText = pokemon.location;
                                document.getElementById('modalType').innerHTML = `
                                    <span style="background-color: ${type1Color}; padding: 5px; border-radius: 5px; color: white; width: 50px; display: inline-block; text-align: center;">${pokemon.type1}</span>
                                    ${pokemon.type2 ? `<span style="background-color: ${type2Color}; padding: 5px; border-radius: 5px; color: white; width: 50px; display: inline-block; text-align: center; margin-left: 5px;">${pokemon.type2}</span>` : ''}
                                `;
                                document.getElementById('introduction').innerText=pokemon.introduction;
                                // document.getElementById('modalImage').src = pokemon.imageUrl;
                                $('#pokemonModal').modal('show');
                                load3DModel();
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            }
            function searchPokemon(query, mode) {
                let url = '';
                switch (mode) {
                    case 'name':
                        url = `/search-Pokemonbyname/${query}`;
                        break;
                    case 'type':
                        url = `/search-Pokemonbytype/${query}`;
                        break;
                    case 'pid':
                        url = `/search-PokemonbyPid/${query}`;
                        break;
                }

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.getElementById('pokemonTableBody');
                        tbody.innerHTML = ''; // 清空表格
                        data.pokemons.forEach(pokemon => {
                            const row = document.createElement('tr');
                            const type1Color = typeColors[pokemon.type1] || 'white';
                            const type2Color = typeColors[pokemon.type2] || 'white';

                            row.innerHTML = `
                                <td>${pokemon.pid}</td>
                                <td>${pokemon.pname}</td>
                                <td>${pokemon.location}</td>
                                <td>
                                    <span style="background-color: ${type1Color}; padding: 5px; border-radius: 5px; color: white; width: 50px; display: inline-block; text-align: center;">${pokemon.type1}</span>
                                    ${pokemon.type2 ? `<span style="background-color: ${type2Color}; padding: 5px; border-radius: 5px; color: white; width: 50px; display: inline-block; text-align: center; margin-left: 5px;">${pokemon.type2}</span>` : ''}
                                </td>
                                <td><img src="${pokemon.imageUrl}" alt="${pokemon.pname}" width="50" height="50"></td>
                                <td><button class="btn btn-info show-details" data-pokemon='${JSON.stringify(pokemon)}'>详情</button></td>
                            `;
                            tbody.appendChild(row);
                        });

                        document.querySelectorAll('.show-details').forEach(button => {
                            button.addEventListener('click', function() {
                                const pokemon = JSON.parse(this.getAttribute('data-pokemon'));
                                const type1Color = typeColors[pokemon.type1] || 'white';
                                const type2Color = typeColors[pokemon.type2] || 'white';

                                document.getElementById('modalPid').innerText = pokemon.pid;
                                document.getElementById('modalPname').innerText = pokemon.pname;
                                document.getElementById('modalLocation').innerText = pokemon.location;
                                document.getElementById('modalType').innerHTML = `
                                    <span style="background-color: ${type1Color}; padding: 5px; border-radius: 5px; color: white; width: 50px; display: inline-block; text-align: center;">${pokemon.type1}</span>
                                    ${pokemon.type2 ? `<span style="background-color: ${type2Color}; padding: 5px; border-radius: 5px; color: white; width: 50px; display: inline-block; text-align: center; margin-left: 5px;">${pokemon.type2}</span>` : ''}
                                `;
                                document.getElementById('introduction').innerText=pokemon.introduction;
                                $('#pokemonModal').modal('show');
                                load3DModel();
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            }

            // 监听模态框关闭事件
            $('#pokemonModal').on('hidden.bs.modal', function () {
                clear3DModel();
            });

            let animationFrameId;

            function load3DModel() {
            // 基本设置
            let container = document.getElementById('container3d');
            let scene = new THREE.Scene();
            let camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            let renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1;
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);

            // 替换背景
            let textureLoader = new THREE.TextureLoader();
            textureLoader.load('photo/Battle Background.jpg', function(texture) {
                scene.background = texture;
            });

            // 添加光源
            let hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.3);
            hemiLight.position.set(0, 500, 0);
            scene.add(hemiLight);

            let dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight.position.set(0, 200, 100);
            dirLight.castShadow = true;
            dirLight.shadow.camera.top = 180;
            dirLight.shadow.camera.bottom = -100;
            dirLight.shadow.camera.left = -120;
            dirLight.shadow.camera.right = 120;
            scene.add(dirLight);

            // 设置相机位置
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);

            // 添加 OrbitControls
            let controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2;
            controls.enableZoom = true;
            controls.zoomSpeed = 1.2;

            // 加载模型并自动缩放和渲染颜色
            let model; // 定义一个变量来引用加载的模型

            let mtlLoader = new THREE.MTLLoader();
            let objLoader = new THREE.OBJLoader();

            console.log('Loading MTL file...');
            mtlLoader.load(
                '3D/obj.mtl',
                function(materials) {
                    console.log('MTL file loaded successfully');
                    materials.preload();
                    objLoader.setMaterials(materials);
                    objLoader.load('3D/obj.obj', function(obj) {
                        console.log('OBJ file loaded successfully with MTL materials');
                        processObject(obj);
                    }, undefined, function(error) {
                        console.error('Error loading OBJ file with MTL materials:', error);
                    });
                },
                undefined,
                function(error) {
                    console.warn('MTL file not found or failed to load:', error);
                    // 如果没有找到 MTL 文件，就直接加载 OBJ 文件
                    objLoader.load('3D/obj.obj', function(obj) {
                        console.log('OBJ file loaded successfully without MTL materials');
                        applyTexture(obj, '3D/UV.png'); // 使用 PNG 纹理
                        processObject(obj);
                    }, undefined, function(error) {
                        console.error('Error loading OBJ file without MTL materials:', error);
                    });
                }
            );
            function applyTexture(obj, texturePath) {
                console.log('Applying texture...');
                let textureLoader = new THREE.TextureLoader();
                let texture = textureLoader.load(texturePath, function() {
                    console.log('Texture loaded successfully');
                }, undefined, function(error) {
                    console.error('Error loading texture:', error);
                });

                obj.traverse(function(child) {
                    if (child.isMesh) {
                        child.material.map = texture;
                        child.material.needsUpdate = true;
                    }
                });
            }

            function processObject(obj) {
                // 计算模型包围盒
                console.log('Processing object...');
                let bbox = new THREE.Box3().setFromObject(obj);
                let center = bbox.getCenter(new THREE.Vector3());
                let size = bbox.getSize(new THREE.Vector3());

                // 计算缩放比例
                let maxSize = Math.max(size.x, size.y, size.z);
                let scale = 10 / maxSize;

                // 应用缩放和位移
                obj.scale.set(scale, scale, scale);
                obj.position.sub(center.multiplyScalar(scale));

                if (model) {
                    scene.remove(model); // 移除之前的模型
                }
                model = obj; // 保存对模型的引用
                scene.add(obj);

                animate(); // 确保动画循环开始
                renderer.render(scene, camera); // 初始渲染
                console.log('Object added to scene');
            }

            // 窗口大小调整
            window.addEventListener('resize', function() {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.render(scene, camera); // 确保调整大小后重新渲染
            });


            // 动画循环
                function animate() {
                    animationFrameId = requestAnimationFrame(animate);
                    controls.update();
                    if (model) {
                        model.rotation.y += 0.0005; // 自动旋转模型
                    }
                    renderer.render(scene, camera);
                }


            // 开始动画
            animate();
        }

            function clear3DModel() {
                let container = document.getElementById('container3d');
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
            }
        });
    </script>
</body>
</html>
